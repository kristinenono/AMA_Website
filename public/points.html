<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Single Page Layout</title>
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://kit.fontawesome.com/bcae03608a.js"
      crossorigin="anonymous"
    ></script>
    <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
  />
  </head>
  <body>
    <main>
      <div id="editmodal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
          <div class="box">
            <div class="field">
              <label class="label">Member:</label>
              <div class="control">
                <div class="select">
                  <select id="memberSelect">
                    <!-- Member options will be populated dynamically -->
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">Semester:</label>
              <div class="control">
                <div class="select">
                  <select id="editSemester">
                    <option value="SPRING 2024">SPRING 2024</option>
                    <option value="FALL 2024">FALL 2024</option>
                    <option value="SPRING 2025">SPRING 2025</option>
                    <option value="FALL 2025">FALL 2025</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">Code:</label>
              <div class="control">
                <input class="input" type="text" id="editCode" placeholder="Enter code">
              </div>
            </div>
            <div class="field">
              <label class="label">Points:</label>
              <div class="control">
                <input class="input" type="number" id="editPoints" placeholder="Enter points">
              </div>
            </div>
            <div class="field">
              <label class="label">Event Type:</label>
              <div class="control">
                <div class="select">
                  <select id="editEventType">
                    <option value="volunteer">Volunteer</option>
                    <option value="professional_development">Professional Development</option>
                    <option value="social">Social</option>
                    <option value="speaker">Speaker</option>
                    <option value="dei">DEI</option>
                  </select>
                </div>
              </div>
            </div>
            <button class="button is-link" onclick="saveEditChanges()">Save</button>
            <button id="editclear" class="button is-link">Clear</button>
          </div>
        </div>
        <button id="editclose" class="modal-close is-large" aria-label="close"></button>
      </div>

      <div class="filter-container">
        <div class="filtername">
          <label for="nameSearch">Search by Name:</label>
          <input type="text" id="nameSearch" placeholder="Search name...">
        </div>
        <div class="filtersem">
          <label for="semesterFilter">Filter by Semester:</label>
          <select id="semesterFilter">
                  <option value="SPRING 2024">SPRING 2024</option>
                  <option value="FALL 2024">FALL 2024</option>
                  <option value="SPRING 2025">SPRING 2025</option>
                  <option value="FALL 2025">FALL 2025</option>
              </select>
          <!-- <label for="eventFilter">Filter by Event:</label>
          <select id="eventFilter">
              <option data-event="Total Points">All</option>
              <option data-event="Volunteer Points">Volunteer Points</option>
              <option data-event="Development Points">Development Points</option>
              <option data-event="Social Points">Social Points</option>
              <option data-event="Speaker Points">Speaker Points</option>
              <option data-event="DEI Points">DEI Points</option>
          </select> -->
        </div>
          <button id="applyFilters" class="redbtn pointbtn">Apply Filters</button>
          <button id="editbtn" class="bluebtn pointbtn">Edit Points</button>
      </div>   
      <div id="savecancelbtn" class="container editsavecancel is-hidden">
        <button id="editsave" class="bluebtn pointbtn">Save</button>
        <button id="editcancel" class="redbtn pointbtn">Cancel</button>
      </div>              
      <table class="table is-bordered">
          <thead>
            <tr>
              <th class="has-text-white">Member</th>
              <th class="has-text-white">Semester</th>
              <th class="has-text-white">Volunteer Points</th>
              <th class="has-text-white">Development Points</th>
              <th class="has-text-white">Social Points</th>
              <th class="has-text-white">Speaker Points</th>
              <th class="has-text-white">DEI Points</th>
              <th class="has-text-white">Total Points</th>
          </tr>
          </thead>
          <tbody
      id="all_people"
      class="p-4 m-3"
    >
      <!-- Table rows will be dynamically added here -->
    </tbody>
    </table>
    </main>
    <!-- <script src="app.js"></script> -->
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>

    <script>
      // TODO
      // Copy **only** your firebaseConfig from Google Firebae and add it below

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBEZAtfgyF88HPoBR94OxTJe0Io7lyKbjA",
        authDomain: "amabadgers.firebaseapp.com",
        projectId: "amabadgers",
        storageBucket: "amabadgers.appspot.com",
        messagingSenderId: "131147849099",
        appId: "1:131147849099:web:a969b845dd736bbc2de38e",
        measurementId: "G-907H1EJYVP",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      // define authentication variable
      let auth = firebase.auth();
      let db = firebase.firestore();

      // define a storage reference
      let ref = firebase.storage().ref();

    function getCurrentSemester() {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth(); // Month is zero-based

        // Determine the semester based on the current month
        let currentSemester;
        if (currentMonth >= 0 && currentMonth <= 5) {
            currentSemester = "SPRING " + currentDate.getFullYear();
        } else {
            currentSemester = "FALL " + currentDate.getFullYear();
        }

        return currentSemester.toUpperCase();;
    }

    // function to show points on the table for a member
function fetchAndPopulatePoints(selectedSemester, searchQuery) {
    selectedSemester = selectedSemester || getCurrentSemester();

    // Fetch all users from the ama_users collection
    db.collection("ama_users").get().then((userSnapshot) => {
        const memberTotalPoints = {};
        const memberPointsPromises = [];

        // Iterate over each user document
        userSnapshot.forEach((userDoc) => {
            const fullName = userDoc.data().full_name;
            memberTotalPoints[fullName] = {
                volunteer: 0,
                professional_development: 0,
                social: 0,
                speaker: 0,
                dei: 0
            };
            const pointsPromise = db.collection("ama_users").doc(userDoc.id).collection("member_points")
            .where("pointSemester", "==", selectedSemester)
            .get()
            .then((pointsSnapshot) => {
                pointsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const eventType = data.eventType.toLowerCase().replace(" ", "_");
                    const eventPoints = data.points; // Get the number of points

                    if (memberTotalPoints[fullName] && eventType in memberTotalPoints[fullName]) {
                        memberTotalPoints[fullName][eventType] += eventPoints;
                    }
                });
            }).catch((error) => {
                console.error(`Error getting points for user ${fullName}: `, error);
            });

            memberPointsPromises.push(pointsPromise);
        });

        Promise.all(memberPointsPromises).then(() => {
            updateTableWithData(memberTotalPoints, selectedSemester, searchQuery);
        }).catch((error) => {
            console.error("Error processing member points data: ", error);
        });
    }).catch((error) => {
        console.error("Error getting users documents: ", error);
    });
}

function updateTableWithData(memberTotalPoints, selectedSemester, searchQuery) {
    const tableBody = document.getElementById("all_people");
    tableBody.innerHTML = "";

    Object.entries(memberTotalPoints).forEach(([fullName, points]) => {
        if (!searchQuery || fullName.toLowerCase().includes(searchQuery.toLowerCase())) {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${fullName}</td>
                <td>${selectedSemester}</td>
                <td>${points.volunteer}</td>
                <td>${points.professional_development}</td>
                <td>${points.social}</td>
                <td>${points.speaker}</td>
                <td>${points.dei}</td>
                <td>${points.volunteer + points.professional_development + points.social + points.speaker + points.dei}</td>
            `;
            tableBody.appendChild(row);
        }
    });
}

    // Call the function to fetch and populate points when the page loads
    window.onload = function () {
        fetchAndPopulatePoints();
    };

    document.getElementById("applyFilters").addEventListener("click", function () {
  // Get the filter values
  const nameSearchValue = document.getElementById("nameSearch").value.trim().toLowerCase();
  const semesterFilterValue = document.getElementById("semesterFilter").value.toUpperCase();

  // Call fetchAndPopulatePoints with the selected semester and search query
  fetchAndPopulatePoints(semesterFilterValue, nameSearchValue);
});

let editbutton = document.getElementById("editbtn");
let editmodal = document.getElementById("editmodal");
let editclose = document.getElementById("editclose");


editbutton.addEventListener("click", () => {
  editmodal.classList.add("is-active");
});

editclose.addEventListener("click", () => {
  editmodal.classList.remove("is-active");
});

  function populateMemberDropdown() {
  const select = document.getElementById('memberSelect');
  select.innerHTML = ''; // Clear existing options
  db.collection('ama_users').get().then((snapshot) => {
    snapshot.forEach((doc) => {
      const fullName = doc.data().full_name;
      const option = document.createElement('option');
      option.value = doc.id; // Use user's document ID as value
      option.textContent = fullName;
      select.appendChild(option);
    });
  }).catch((error) => {
    console.error("Error fetching members: ", error);
  });
}

function saveEditChanges() {
  const memberId = document.getElementById('memberSelect').value;
  const code = document.getElementById('editCode').value;
  const semester = document.getElementById('editSemester').value;
  const eventType = document.getElementById('editEventType').value;
  const points = parseInt(document.getElementById('editPoints').value); // Get the points from the input

  if (!points || points < 0) {
    alert('Please enter a valid number of points.');
    return;
  }

  // Assuming you will update or set data in member_points collection
  db.collection('ama_users').doc(memberId).collection('member_points').add({
    code: code,
    eventType: eventType,
    pointSemester: semester,
    points: points // Use the dynamically provided points
  }).then(() => {
    console.log("Points updated successfully");
    fetchAndPopulatePoints(semester, ''); // Refresh the points table
    editmodal.classList.remove('is-active');
  }).catch((error) => {
    console.error("Error updating points: ", error);
  });
}

editbutton.addEventListener('click', () => {
  populateMemberDropdown(); // Populate dropdown when modal is activated
  editmodal.classList.add('is-active');
});

editclose.addEventListener('click', () => {
  editmodal.classList.remove('is-active');
});

document
  .querySelectorAll(".modal-background, .modal-close")
  .forEach(function (el) {
    el.addEventListener("click", function () {
      editmodal.classList.remove("is-active");
    });
  });

  let editclear = document.getElementById("editclear");
  document.getElementById('editclear').addEventListener('click', function() {
    document.getElementById('editCode').value = '';
    document.getElementById('editSemester').selectedIndex = 0;
    document.getElementById('editEventType').selectedIndex = 0;
    document.getElementById('memberSelect').selectedIndex = 0;
  });

    </script>
  </body>
</html>