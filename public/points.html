<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Single Page Layout</title>
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://kit.fontawesome.com/bcae03608a.js"
      crossorigin="anonymous"
    ></script>
    <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
  />
  </head>
  <body>
    <header>
        <div class="navbar-menu">
          <div>
            <a href="index.html" id="home-link"><strong id="home-nav">HOME</strong></a>
            <a id="format-link1"><strong id="format-nav">ABOUT</strong></a>
            <div class="dropdown">
              <button class="bttn1"><strong id="format-nav">MEMBERS</strong></button>
              <div class="dropdown-content">
                <a href="calendar.html" id="calendarbtn">CALENDAR</a>
                <a href="points.html" id="pointbtn">POINT SYSTEM</a>
              </div>
            </div>          
            <a href="blog.html" id="blog-link"><strong id="format-nav">BLOG</strong></a>
            <a id="format-link"><strong id="format-nav">CONTACT</strong></a>
            <!-- hiding the modal burger since its interfering with the index page -->
          <!-- <div class="login-signup-burger">
            <a id="login">
              <button id="logbtn" class="add-btn button">
                <strong id="bttn-font">LOGIN</strong>
              </button>
            </a>
            &nbsp; &nbsp;
            <a id="signin">
              <button id="signbtn" class="add-btn button">
                <strong id="bttn-font">SIGN UP</strong>
              </button>
            </a>
          </div> -->
        </div>
        </div>
      </nav>
    </header>
    <main>  
        <div class="filter-container">
          <div class="filtername">
            <label for="nameSearch">Search by Name:</label>
            <input type="text" id="nameSearch" placeholder="Search name...">
          </div>
          <div class="filtersem">
            <label for="semesterFilter">Filter by Semester:</label>
            <select id="semesterFilter">
                <option value="SPRING 2024">SPRING 2024</option>
                <option value="FALL 2024">FALL 2024</option>
                <option value="SPRING 2025">SPRING 2025</option>
                <option value="FALL 2025">FALL 2025</option>
            </select>
            <!-- <label for="eventFilter">Filter by Event:</label>
            <select id="eventFilter">
                <option data-event="Total Points">All</option>
                <option data-event="Philanthropy Points">Philanthropy Points</option>
                <option data-event="Developement Points">Developement Points</option>
                <option data-event="Social Points">Social Points</option>
                <option data-event="Speaker Points">Speaker Points</option>
            </select> -->
          </div>
            <button id="applyFilters" class="redbtn pointbtn">Apply Filters</button>
            <button id="editbtn" class="bluebtn pointbtn">Edit Points</button>
        </div>   
        <div id="savecancelbtn" class="container editsavecancel is-hidden">
          <button id="editsave" class="bluebtn pointbtn">Save</button>
          <button id="editcancel" class="redbtn pointbtn">Cancel</button>
        </div>              
        <table class="table is-bordered is-striped is-hoverable">
            <thead>
              <tr>
                <th class="has-text-white">Member</th>
                <th class="has-text-white">Semester</th>
                <th class="has-text-white">Philanthropy Points</th>
                <th class="has-text-white">Development Points</th>
                <th class="has-text-white">Social Points</th>
                <th class="has-text-white">Speaker Points</th>
                <th class="has-text-white">Total Points</th>
            </tr>
            </thead>
            <tbody
        id="all_people"
        class="has-background-lightgray p-4 m-3 has-background-grey-lighter"
      >
        <!-- Table rows will be dynamically added here -->
      </tbody>
    </table>
    </main>
    <footer>
        <div class="footer-box">
          <div class="footer-section">
            <div class="navbar-items">
              <img src="images/AMA_Logo_Footer.png" alt="" id="img_logo">
              <div id="uw-wisc">
                <strong id="footer-uw-logo" class="text-logo">University of Wisconsin </br> Madison</strong>
              </div>
            </div>
            <div class="social-icons" id="icons">
                <a href="https://www.linkedin.com/in/ama-badgers-5247a9252/" id="social-icon">
                  <i class="fab fa-linkedin fa-2x"></i>
                </a>
                <a href="https://www.instagram.com/amabadgers/" id="social-icon">
                  <i class="fab fa-instagram fa-2x"></i>
                </a>
                <a href="https://www.facebook.com/AMAUWMadison/" id="social-icon">
                  <i class="fab fa-facebook fa-2x"></i>
                </a>
                <a href="https://twitter.com/amauwmadison?lang=en">
                  <i class="fab fa-twitter fa-2x"></i>
                </a>
            </div>
            <div id="adress">
              <p>975 University Ave, Madison, WI 53706</p>
              <p id="phone">+00 000 000 000</p>
            </div>
          </div>
          <div class="footer-section" id="footer-link-padding">
            <div>
              <div id="footer-padding">
                <a href="#" ><b>About Us</b></a>
              </div>
              <div id="footer-padding">
                <a href="#"><b>Blog</b></a>
              </div>
              <div id="footer-padding">
                <a href="#"><b>Point System</b></a>
              </div>
              <div id="footer-padding">
                <a href="#"><b>Contact Us</b></a>
              </div>
              <div id="footer-padding">
                <a href="calendar.html"><b>Events</b></a>
              </div>
              <div id="footer-padding">
                <a href="#"><b>Become a Sponsor</b></a>
              </div>
            </div>
          </div>
          <div id="line"></div>
          <div class="footer-section">
            <h2>JOIN OUR EMAIL LIST</h2>
            <p>Want to become an official member of the Badger American Marketing Association or just be added to the email list? Fill out our member form to stay up to date on upcoming events!</p>
            <input type="text" placeholder="Enter your email here">
            <button id="submit_btn">
              <p>SUBMIT</p>
            </button>
          </div>
        </div>
      </footer>
    <!-- <script src="app.js"></script> -->
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>

    <script>
      // TODO
      // Copy **only** your firebaseConfig from Google Firebae and add it below

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBEZAtfgyF88HPoBR94OxTJe0Io7lyKbjA",
        authDomain: "amabadgers.firebaseapp.com",
        projectId: "amabadgers",
        storageBucket: "amabadgers.appspot.com",
        messagingSenderId: "131147849099",
        appId: "1:131147849099:web:a969b845dd736bbc2de38e",
        measurementId: "G-907H1EJYVP",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      // define authentication variable
      let auth = firebase.auth();
      let db = firebase.firestore();

      // define a storage reference
      let ref = firebase.storage().ref();

    function getCurrentSemester() {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth(); // Month is zero-based

        // Determine the semester based on the current month
        let currentSemester;
        if (currentMonth >= 0 && currentMonth <= 5) {
            currentSemester = "SPRING " + currentDate.getFullYear();
        } else {
            currentSemester = "FALL " + currentDate.getFullYear();
        }

        return currentSemester.toUpperCase();;
    }

    function updateTableWithData(memberTotalPoints, selectedSemester, searchQuery) {
    const tableBody = document.getElementById("all_people");
    tableBody.innerHTML = ""; // Clear existing table rows

    // Iterate over each member and populate the table
    for (const fullName in memberTotalPoints) {
        const totalPoints = memberTotalPoints[fullName];

        // Check if the member's name matches the search query
        if (searchQuery && !fullName.toLowerCase().includes(searchQuery)) {
            continue; // Skip this member if it doesn't match the search query
        }

        // Create a new row for the member
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
            <td>${fullName}</td>
            <td>${selectedSemester}</td>
            <td>${totalPoints.philanthropy}</td>
            <td>${totalPoints.professional_development}</td>
            <td>${totalPoints.social}</td>
            <td>${totalPoints.speaker}</td>
            <td>${totalPoints.philanthropy + totalPoints.professional_development + totalPoints.social + totalPoints.speaker}</td>
        `;

        // Append the row to the table
        tableBody.appendChild(newRow);
    }

    calculateTotalPoints(); // Calculate total points after populating individual points
}


function fetchAndPopulatePoints(selectedSemester, searchQuery) {
    selectedSemester = selectedSemester || getCurrentSemester(); // Default to current semester if not provided
    db.collection("ama_users").get().then((userSnapshot) => {
        const rows = document.querySelectorAll("#all_people tr");

        // Create an object to store total points for each member
        const memberTotalPoints = {};

        // Iterate over each document in the user snapshot
        userSnapshot.forEach((userDoc) => {
            const fullName = userDoc.data().full_name;
            memberTotalPoints[fullName] = {
                philanthropy: 0,
                professional_development: 0,
                social: 0,
                speaker: 0
            };
        });

        // Get member points from member_points collection
        db.collection("member_points").get().then((snapshot) => {
            // Iterate over each document in the member points snapshot
            snapshot.forEach((doc) => {
                const data = doc.data();
                const fullName = data.member;
                const eventType = data.eventType.toLowerCase();
                const eventPoints = parseInt(data.points) || 0;
                const pointSemester = data.pointSemester.toUpperCase();

                // Check if the member exists in the object and the points are for the selected semester
                if (
                    memberTotalPoints[fullName] &&
                    (
                        selectedSemester === pointSemester ||
                        (selectedSemester === getCurrentSemester() && pointSemester === getCurrentSemester())
                    ) &&
                    // Check if the search query matches the member's name
                    (searchQuery ? fullName.toLowerCase().includes(searchQuery) : true)
                ) {
                    // Add points to the respective event type
                    memberTotalPoints[fullName][eventType] += eventPoints;
                }
            });

            // Pass selected semester to updateTableWithData function
            // Pass the searchQuery to the updateTableWithData function
          updateTableWithData(memberTotalPoints, selectedSemester, searchQuery);

        }).catch((error) => {
            console.error("Error getting member points documents: ", error);
        });
    }).catch((error) => {
        console.error("Error getting users documents: ", error);
    });
}

    function calculateTotalPoints() {
        const rows = document.querySelectorAll("#all_people tr");
        rows.forEach((row) => {
            let totalPoints = 0;
            for (let i = 2; i < row.cells.length - 1; i++) {
                totalPoints += parseInt(row.cells[i].textContent) || 0;
            }
            row.cells[row.cells.length - 1].textContent = totalPoints;
        });
    }

    // Call the function to fetch and populate points when the page loads
    window.onload = function () {
        fetchAndPopulatePoints();
    };

    document.getElementById("applyFilters").addEventListener("click", function () {
  // Get the filter values
  const nameSearchValue = document.getElementById("nameSearch").value.trim().toLowerCase();
  const semesterFilterValue = document.getElementById("semesterFilter").value.toUpperCase();

  // Call fetchAndPopulatePoints with the selected semester and search query
  fetchAndPopulatePoints(semesterFilterValue, nameSearchValue);
});


    // EDIT BUTTON
let editbutton = document.getElementById("editbtn");
let savecancelbtn = document.getElementById("savecancelbtn");

// for the original points to be saved
let originalvalues = [];


// function to allow the points to be edited
function editpointsmode(editMode) {
    const pointsCells = document.querySelectorAll("tbody tr td:nth-child(n+3):nth-child(-n+6)");
    
    if (editMode) {
        originalValues = []; // Reset original values
        pointsCells.forEach(cell => {
            // Store the original text
            originalValues.push(cell.innerText);
            // Replace cell content with an input element
            cell.innerHTML = `<input class="input" type="number" value="${cell.innerText}" placeholder="${cell.innerText}" style="width: 100%;">`;
        });
    } else {
        // If not edit mode, we revert back to the original text or save new values
        pointsCells.forEach((cell, index) => {
            const input = cell.querySelector("input");
            // If input exists, use its value; otherwise, use the original text
            cell.innerText = input ? input.value : originalValues[index];
        });
    }
}

// open save and cancel when edit button is clicked
function showsavecancel() {
  editpointsmode(true);
  savecancelbtn.classList.remove("is-hidden")
  savecancelbtn.classList.add("is-active");
  editbutton.classList.add("is-hidden")
}
editbutton.addEventListener("click", showsavecancel);

// SAVE CANCEL BUTTON
let editsave = document.getElementById("editsave");
let editcancel =document.getElementById("editcancel");

// when the cancel button is clicked it will hide and bring back the edit button
function canceledit() {
  savecancelbtn.classList.add("is-hidden")
  savecancelbtn.classList.remove("is-active");
  editbutton.classList.remove("is-hidden");
  editpointsmode(false);
  fetchAndPopulatePoints();
  
}
editcancel.addEventListener("click", canceledit);

// when the save button is clicked it will save all the values from the edit and update the database
function saveedit() {
    // Code to reset UI after save
    savecancelbtn.classList.add("is-hidden");
    editbutton.classList.remove("is-hidden");
    // Disable edit mode
    editpointsmode(false);
    // Optionally, refresh the table data
    fetchAndPopulatePoints();
}
editsave.addEventListener("click", saveedit);


const eventsCollectionRef = db.collection("events"); // Replace "events" with the actual name of your events collection
const formResponsesCollectionRef = db.collection("form_responses"); // Replace "form_responses" with the actual name of your form responses collection
const mergedCollectionRef = db.collection("member_points"); // Replace "merged_data" with the actual name of your merged data collection


//Need to fix so that the function can take form_responses.attended_members as an array      

async function mergeDataAndDeleteDuplicates() {
  try {
    const eventsSnapshot = await eventsCollectionRef.get();
    const formResponsesSnapshot = await formResponsesCollectionRef.get();
    const mergedDocsSnapshot = await mergedCollectionRef.get();

    const formResponsesData = {};
    formResponsesSnapshot.forEach(doc => {
      const formData = doc.data();
      formResponsesData[formData.code] = formData;
    });

    const existingKeys = new Set();
    const batch = firebase.firestore().batch();

    eventsSnapshot.forEach(eventsDoc => {
      const eventData = eventsDoc.data();
      const eventCode = eventData.code;

      if (formResponsesData[eventCode]) {
        const formResponseData = formResponsesData[eventCode];
        const key = `${eventCode}_${formResponseData.attended_members}`;

        if (!existingKeys.has(key)) {
          existingKeys.add(key);
          const mergedData = {
            code: eventCode,
            eventType: eventData.type,
            points: eventData.pts,
            pointSemester: eventData.semester,
            member: formResponseData.attended_members,
            key: key,
          };
          batch.set(mergedCollectionRef.doc(key), mergedData);
        }
      }
    });

    await batch.commit();

    const uniqueKeys = new Set();
    const deleteBatch = firebase.firestore().batch();

    mergedDocsSnapshot.forEach(doc => {
      const key = doc.data().key;
      if (uniqueKeys.has(key)) {
        deleteBatch.delete(doc.ref);
      } else {
        uniqueKeys.add(key);
      }
    });

    await deleteBatch.commit();

    console.log("Operation completed successfully.");
  } catch (error) {
    console.error("Operation failed: ", error);
  }
}

// Execute the function to merge data and delete duplicates
mergeDataAndDeleteDuplicates();

    </script>
  </body>
</html>