<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Single Page Layout</title>
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://kit.fontawesome.com/bcae03608a.js"
      crossorigin="anonymous"
    ></script>
    <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
  />
  </head>
  <body>
    <main>
      <div id="editmodal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
          <div class="box">
            <div class="field">
              <label class="label">Member:</label>
              <div class="control">
                <div class="select">
                  <select id="memberSelect">
                    <!-- Member options will be populated dynamically -->
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">Semester:</label>
              <div class="control">
                <div class="select">
                  <select id="editSemester" disabled>
                    <option value="SPRING 2024">SPRING 2024</option>
                    <option value="FALL 2024">FALL 2024</option>
                    <option value="SPRING 2025">SPRING 2025</option>
                    <option value="FALL 2025">FALL 2025</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">Code:</label>
              <div class="control">
                <input class="input" type="text" id="editCode" placeholder="Enter code">
              </div>
            </div>
            <div class="field">
              <label class="label">Points:</label>
              <div class="control">
                <input class="input" type="number" id="editPoints" placeholder="Enter points" disabled>
              </div>
            </div>
            <div class="field">
              <label class="label">Event Type:</label>
              <div class="control">
                <div class="select">
                  <select id="editEventType" disabled>
                    <option value="Volunteer">Volunteer</option>
                    <option value="Professional Development">Professional Development</option>
                    <option value="Speaker Event">Speaker</option>
                    <option value="Social Event">Social</option>
                    <option value="DEI Event">DEI</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">Event Name:</label>
              <input class="input" type="text" id="eventName" placeholder="Event Name" disabled>
            </div>
            <div class="field">
              <label class="label">Event Description:</label>
              <input class="input" type="text" id="eventDesc" placeholder="Description" disabled>
            </div>
            <div class="field">
              <label class="label">Event Time:</label>
              <input class="input" type="text" id="eventTime" placeholder="Time" disabled>
            </div>
            <button id="saveaddpoints" class="button is-link">Save</button>
            <button id="editclear" class="button is-link">Clear</button>
          </div>
        </div>
        <button id="editclose" class="modal-close is-large" aria-label="close"></button>
      </div>



      <div id="showmodal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
          <div class="box">
            <div class="field">
              <label class="label">Select Member:</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="showMemberSelect"></select>
                </div>
              </div>
            </div>
            <table class="table is-striped is-narrow is-hoverable is-fullwidth">
              <thead>
                <tr>
                  <th class="has-text-white">Code</th>
                  <th class="has-text-white">Event Type</th>
                  <th class="has-text-white">Points</th>
                  <th class="has-text-white">Semester</th>
                  <th class="has-text-white">Action</th>
                </tr>
              </thead>
              <tbody id="memberPointsList"></tbody>
            </table>
            <button id="showclose" class="button">Close</button>
          </div>
        </div>
        <button id="showeditclose" class="modal-close is-large" aria-label="close"></button>
      </div>




      <div class="filter-container">
        <div class="filtername">
          <label for="nameSearch">Search by Name:</label>
          <input type="text" id="nameSearch" placeholder="Search name...">
        </div>
        <div class="filtersem">
          <label for="semesterFilter">Filter by Semester:</label>
          <select id="semesterFilter">
                  <option value="SPRING 2024">SPRING 2024</option>
                  <option value="FALL 2024">FALL 2024</option>
                  <option value="SPRING 2025">SPRING 2025</option>
                  <option value="FALL 2025">FALL 2025</option>
              </select>
        </div>
          <button id="applyFilters" class="redbtn pointbtn">Apply Filters</button>
          <button id="editbtn" class="bluebtn pointbtn">Edit Points</button>
          <button id="canceledit" class="bluebtn pointbtn is-hidden">Cancel Edit</button>
      </div>   
      <div id="addshowbtn" class="container editsavecancel is-hidden">
        <button id="addedit" class="bluebtn pointbtn">Add Points</button>
        <button id="showedit" class="redbtn pointbtn">Show Points</button>
      </div>              
      <table class="table is-bordered">
          <thead>
            <tr>
              <th class="has-text-white">Member</th>
              <th class="has-text-white">Semester</th>
              <th class="has-text-white">Volunteer Points</th>
              <th class="has-text-white">Development Points</th>
              <th class="has-text-white">Social Points</th>
              <th class="has-text-white">Speaker Points</th>
              <th class="has-text-white">DEI Points</th>
              <th class="has-text-white">Total Points</th>
          </tr>
          </thead>
          <tbody
      id="all_people"
      class="p-4 m-3"
    >
      <!-- Table rows will be dynamically added here -->
    </tbody>
    </table>
    </main>
    <!-- <script src="app.js"></script> -->
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>

    <script>
      // TODO
      // Copy **only** your firebaseConfig from Google Firebae and add it below

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBEZAtfgyF88HPoBR94OxTJe0Io7lyKbjA",
        authDomain: "amabadgers.firebaseapp.com",
        projectId: "amabadgers",
        storageBucket: "amabadgers.appspot.com",
        messagingSenderId: "131147849099",
        appId: "1:131147849099:web:a969b845dd736bbc2de38e",
        measurementId: "G-907H1EJYVP",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      // define authentication variable
      let auth = firebase.auth();
      let db = firebase.firestore();

      // define a storage reference
      let ref = firebase.storage().ref();







    // functions for the table 
    function fetchAndPopulatePoints(selectedSemester, searchQuery) {
    selectedSemester = selectedSemester || getCurrentSemester();

    // fetch all users from the ama_users collection
    db.collection("ama_users").get().then((userSnapshot) => {
        const memberTotalPoints = {};
        const memberPointsPromises = [];

        userSnapshot.forEach((userDoc) => {
            const fullName = userDoc.data().full_name;
            memberTotalPoints[fullName] = {
                volunteer: 0,
                professional_development: 0,
                social: 0,
                speaker: 0,
                dei: 0
            };
            const pointsPromise = db.collection("ama_users").doc(userDoc.id).collection("member_points")
    .where("pointSemester", "==", selectedSemester)
    .get()
    .then((pointsSnapshot) => {
        pointsSnapshot.forEach((doc) => {
            const data = doc.data();
            const eventType = normalizeEventType(data.eventType); // Use the normalized event type
            const eventPoints = parseInt(data.points); // Ensure the points are treated as numbers

            if (memberTotalPoints[fullName] && eventType in memberTotalPoints[fullName]) {
                memberTotalPoints[fullName][eventType] += eventPoints;
            }
        });
    }).catch((error) => {
        console.error(`Error getting points for user ${fullName}: `, error);
    });

            memberPointsPromises.push(pointsPromise);
        });

        Promise.all(memberPointsPromises).then(() => {
            updateTableWithData(memberTotalPoints, selectedSemester, searchQuery);
        }).catch((error) => {
            console.error("Error processing member points data: ", error);
        });
    }).catch((error) => {
        console.error("Error getting users documents: ", error);
    });
}

function updateTableWithData(memberTotalPoints, selectedSemester, searchQuery) {
    const tableBody = document.getElementById("all_people");
    tableBody.innerHTML = "";

    Object.entries(memberTotalPoints).forEach(([fullName, points]) => {
        if (!searchQuery || fullName.toLowerCase().includes(searchQuery.toLowerCase())) {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${fullName}</td>
                <td>${selectedSemester}</td>
                <td>${points.volunteer}</td>
                <td>${points.professional_development}</td>
                <td>${points.social}</td>
                <td>${points.speaker}</td>
                <td>${points.dei}</td>
                <td>${points.volunteer + points.professional_development + points.social + points.speaker + points.dei}</td>
            `;
            tableBody.appendChild(row);
        }
    });
}

    // Call the function to fetch and populate points when the page loads
    window.onload = function () {
  fetchAndPopulatePoints();
  listenForMemberPointsUpdates(); // Start listening for real-time updates
};






      // filtering table functions
    function getCurrentSemester() {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth(); // Month is zero-based

        // Determine the semester based on the current month
        let currentSemester;
        if (currentMonth >= 0 && currentMonth <= 5) {
            currentSemester = "SPRING " + currentDate.getFullYear();
        } else {
            currentSemester = "FALL " + currentDate.getFullYear();
        }

        return currentSemester.toUpperCase();;
    }

    document.getElementById("applyFilters").addEventListener("click", function () {
  // Get the filter values
  const nameSearchValue = document.getElementById("nameSearch").value.trim().toLowerCase();
  const semesterFilterValue = document.getElementById("semesterFilter").value.toUpperCase();

  // Call fetchAndPopulatePoints with the selected semester and search query
  fetchAndPopulatePoints(semesterFilterValue, nameSearchValue);
});


// Function to disable the dropdown
function disableEventTypeDropdown() {
  document.getElementById('editEventType').disabled = true;
}

// Function to enable the dropdown
function enableEventTypeDropdown() {
  document.getElementById('editEventType').disabled = false;
}


function normalizeEventType(eventType) {
    const typeMapping = {
        "Volunteer": "volunteer",
        "Professional Development": "professional_development",
        "Speaker Event": "speaker",
        "Social Event": "social",
        "DEI Event": "dei"
    };
    return typeMapping[eventType] || eventType.toLowerCase().replace(/ /g, "_");
}



// when edit button is clicked it shows the add points, show points and cancel edit buttons
function addshowedit() {
    document.getElementById("canceledit").classList.remove("is-hidden");
    document.getElementById("addshowbtn").classList.remove("is-hidden");
    document.getElementById("addshowbtn").classList.add("is-active");
    document.getElementById("editbtn").classList.add("is-hidden");
  }

  function canceledit() {
    document.getElementById("canceledit").classList.add("is-hidden");
    document.getElementById("addshowbtn").classList.add("is-hidden");
    document.getElementById("addshowbtn").classList.remove("is-active");
    document.getElementById("editbtn").classList.remove("is-hidden");
  }

  document.getElementById("editbtn").addEventListener("click", addshowedit);
  document.getElementById("canceledit").addEventListener("click", canceledit);


  editclose.addEventListener('click', () => {
  editmodal.classList.remove('is-active');
});

document
  .querySelectorAll(".modal-background, .modal-close")
  .forEach(function (el) {
    el.addEventListener("click", function () {
      editmodal.classList.remove("is-active");
      showmodal.classList.remove('is-active');
    });
  });


addedit.addEventListener('click', () => {
  populateMemberDropdown(); // Populate dropdown when modal is activated
  editmodal.classList.add('is-active');
});





function populateMemberDropdown() {
  const select = document.getElementById('memberSelect');
  select.innerHTML = ''; // Clear existing options
  db.collection('ama_users').get().then((snapshot) => {
    snapshot.forEach((doc) => {
      const fullName = doc.data().full_name;
      const option = document.createElement('option');
      option.value = doc.id; // Use user's document ID as value
      option.textContent = fullName;
      select.appendChild(option);
    });
  }).catch((error) => {
    console.error("Error fetching members: ", error);
  });
}

document.getElementById('editCode').addEventListener('input', function() {
  const code = this.value;
  // Assuming event codes are at least some minimum length before checking
  if (code.length >= 8) {
    fetchEventDetails(code);
  }
});

function fetchEventDetails(code) {
    db.collection('events').where('code', '==', code).get()
    .then(querySnapshot => {
        if (!querySnapshot.empty) {
            const eventData = querySnapshot.docs[0].data(); // Assuming the code is unique
            document.getElementById('eventName').value = eventData.name || '';
            document.getElementById('eventDesc').value = eventData.desc || '';
            document.getElementById('eventTime').value = eventData.time || '';
            document.getElementById('editPoints').value = eventData.pts || '';
            document.getElementById('editEventType').value = eventData.type || '';
            document.getElementById('editSemester').value = eventData.semester || '';
            enableInputs(); // Enable inputs after fetching data
        } else {
            console.log("No event found with that code.");
            // Optionally clear fields or alert the user
            clearEventFields(); // Clear fields if no data is found
        }
    })
    .catch(error => {
        console.error("Error fetching event details: ", error);
    });
}

function clearEventFields() {
    document.getElementById('eventName').value = '';
    document.getElementById('eventDesc').value = '';
    document.getElementById('eventTime').value = '';
    document.getElementById('editPoints').value = '';
    document.getElementById('editEventType').selectedIndex = 0;
    document.getElementById('editSemester').selectedIndex = 0;
}

function populateShowMemberDropdown() {
  const select = document.getElementById('showMemberSelect');
  select.innerHTML = ''; // Clear existing options
  db.collection('ama_users').get().then((snapshot) => {
    snapshot.forEach((doc) => {
      const fullName = doc.data().full_name;
      const option = document.createElement('option');
      option.value = doc.id;
      option.textContent = fullName;
      select.appendChild(option);
    });
    if (select.options.length > 0) {
      fetchMemberPoints(select.options[select.selectedIndex].value);
    }
  }).catch((error) => {
    console.error("Error fetching members: ", error);
  });

  // Fetch and display points when a member is selected
  select.addEventListener('change', () => {
    if(select.selectedIndex >= 0) {
      fetchMemberPoints(select.value);
    }
  });
}


function saveEditChanges() {
  const memberId = document.getElementById('memberSelect').value;
  const code = document.getElementById('editCode').value;
  const semester = document.getElementById('editSemester').value;
  const eventType = document.getElementById('editEventType').value;
  const points = parseInt(document.getElementById('editPoints').value);

  if (!points || points < 0) {
    alert('Please enter a valid number of points.');
    return;
  }

  // Assuming you will update or set data in member_points collection
  db.collection('ama_users').doc(memberId).collection('member_points').add({
    code: code,
    eventType: eventType,
    pointSemester: semester,
    points: points
  }).then(() => {
    console.log("Points updated successfully");
    fetchAndPopulatePoints(); // Refresh the points table globally or just for the affected semester
    editmodal.classList.remove('is-active');
    clearaddpoints();
  }).catch((error) => {
    console.error("Error updating points: ", error);
  });
}

function listenForMemberPointsUpdates() {
    db.collection('ama_users').onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === 'added' || change.type === 'modified' || change.type === 'removed') {
                console.log("Detected changes in member points data, refreshing table...");
                fetchAndPopulatePoints();
            }
        });
    });
}

let editclear = document.getElementById("editclear");
  document.getElementById('editclear').addEventListener('click',clearaddpoints);

  function clearaddpoints() {
    document.getElementById('editCode').value = '';
    document.getElementById('editSemester').selectedIndex = 0;
    document.getElementById('editEventType').selectedIndex = 0;
    document.getElementById('memberSelect').selectedIndex = 0;
    document.getElementById('editPoints').value = '';
}

  let saveaddpoints = document.getElementById("saveaddpoints");
  saveaddpoints.addEventListener('click',saveEditChanges);


// Fetch and Display Member Points
function fetchMemberPoints(memberId) {
  const tbody = document.getElementById('memberPointsList');
  tbody.innerHTML = '';  // Clear the table body each time to prevent duplication
  db.collection('ama_users').doc(memberId).collection('member_points')
    .get()
    .then((snapshot) => {
      snapshot.forEach((doc) => {
        const data = doc.data();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${data.code}</td>
          <td>${data.eventType}</td>
          <td>${data.points}</td>
          <td>${data.pointSemester}</td>
          <td><button class="delete-point button is-small is-danger" data-id="${doc.id}">Delete</button></td>
        `;
        tbody.appendChild(row);
      });
      // Attach delete event handlers
      document.querySelectorAll('.delete-point').forEach(button => {
        button.addEventListener('click', () => {
          deletePoint(memberId, button.getAttribute('data-id'));
        });
      });
    }).catch((error) => {
      console.error("Error loading points: ", error);
      tbody.innerHTML = `<tr><td colspan="5">Error loading points</td></tr>`;
    });
}

// Delete a Point Entry
function deletePoint(memberId, pointId) {
  db.collection('ama_users').doc(memberId).collection('member_points').doc(pointId).delete()
    .then(() => {
      console.log('Point deleted successfully');
      fetchMemberPoints(memberId); // Refresh the list after deletion
    }).catch((error) => {
      console.error("Error deleting points: ", error);
    });
}

// Initialize and populate the dropdown when the modal is activated
document.getElementById('showedit').addEventListener('click', () => {
  const select = document.getElementById('showMemberSelect');
  if (select.options.length === 0) { // Only populate if dropdown is empty
    populateShowMemberDropdown();
  }
  document.getElementById('showmodal').classList.add('is-active');
});

let showclose = document.getElementById("showclose");
let showmodal = document.getElementById("showmodal");
let showeditclose = document.getElementById("showeditclose");

// Close the modal
showclose.addEventListener('click', () => {
  showmodal.classList.remove('is-active');
});

showeditclose.addEventListener('click', () => {
  showmodal.classList.remove('is-active');
});


    </script>
  </body>
</html>